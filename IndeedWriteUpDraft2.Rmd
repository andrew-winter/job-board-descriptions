---
title: "Wrangle and analyze job descriptions from indeed.com"
author: "Andrew Winter"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Why process text in R?
R has a huge selection of inuitive, charismatic packages. It has immediate practical use for data analysis, and it pairs well for general-purpose applications. 

Analyzing word choice in job postings might be important for my own decision-making when it comes to roles and applications. Web scraping, organizing, and analyzing this text is easy with a few R packages.


```{r packages, message=FALSE}
# load required packages
library(tidyverse)
library(rvest)
library(tidytext)
```


## Search terms
```{r url}
indeed_search <- paste0(
  'https://www.indeed.com/jobs?q=',
  paste(
    c('data', 'analyst', 'R', 'SQL', 'Python', 'Excel'), collapse = '%2C+'),
  '&l=Los+Angeles%2C+CA')

indeed_search
```


In my experience, using more search terms yields more results on Indeed. If I supply a base url of some analysis terms that I like, I can "page through" the results to collect a bunch of postings.


```{r html session}
sesh <- html_session(indeed_search)

sample_links <- sesh %>%
  read_html() %>%
  html_nodes('h2 a') %>%
  html_attr('href') %>%
  paste0('indeed.com', .)
```


```{r}
sesh %>%
  jump_to(paste0(indeed_search, '&start=20')) %>%
  read_html()
```


## Sample nodes to find
```{r tests}
jobs10 <- sample_links[10] %>%
  html_session() %>%
  read_html()

# description
jobs10 %>%
  html_nodes('.jobsearch-jobDescriptionText') %>%
  html_text()

# role name (to censor, probably)
jobs10 %>%
  html_nodes('.jobsearch-JobInfoHeader-title') %>%
  html_text()

# location
jobs10 %>%
  html_nodes('.jobsearch-DesktopStickyContainer-companyrating+ div') %>%
  html_text()

# org name
jobs10 %>%
  html_nodes('.icl-u-lg-mr--sm') %>%
  html_text()

# this could alternatively, but probably safer to refer to the html tag
"
jobs10 %>%
  html_nodes('div .icl-u-xs-mr--xs') %>%
  `[[`(1) %>%
  html_text()
"
```



## Function to reduce copying and pasting
```{r udf}
safe_mine_text <- function(html_class, str_to_css){
  if ("xml_node" %in% class(html_class) |
      "xml_document" %in% class(html_class)) {
    html_class %>%
      html_nodes(str_to_css) %>%
      html_text()  
  } else {
    NA
  }
}


"
test_df <- tibble(
  role_title = test_nodeset %>%
    html_text('title') %>%
    str_replace_all('\n', ''),
  role_url = test_nodeset %>%
    html_attr('href') %>%
    paste0(base_url, .)
)
"

```



## Old, similar to how it'll be organized later
```{r}
search_nodeset <- indeed_search %>%
  read_html() %>%
  html_nodes('a.jobtitle')

# the argument for html_nodes() is a CSS selector
# extract hyperlink elements whose class is 'jobtitle'
# the Chrome extension SelectorGadget is very useful for finding CSS selectors

search_nodeset

search_df <- tibble(
  role_title = search_nodeset %>%
    html_text('title') %>%
    str_replace_all('\n', ''),
  role_url = search_nodeset %>%
    html_attr('href') %>%
    paste0(indeed_search, .)
)

search_df
```
